// @require JsClass > AudioTrackPlayerTrack
(function(e){e.register("JsClass","AudioTrackPlayer",{classExtends:"BasicWebComp",variables:{tracks:{},beatCount:0,playing:!1,playStampStart:0,timeout:null},options:{bpm:{defaults:120,define:function(a){this.bmpSet(a)}}},init:function(){var a=this;a.wjs.window.addEventListener("focus",function(){a.play()});a.wjs.window.addEventListener("blur",function(){a.pause()})},addTrack:function(a){var b=a.name;this.tracks[b]||(a.player=this,a=new (this.wjs.classProto("AudioTrackPlayerTrack"))(a),this.tracks[b]=
a,this.trackSync(a,0),a.play());return this.tracks[b]},trackSync:function(a,b){var c=this.trackMeasurePosition(a)/1E3;b&&Math.abs(a.audio.currentTime-c)<b||(a.audio.currentTime=c)},trackMeasurePosition:function(a){return this.beatCount%a.beatsLength*this.bpmMiliseconds},removeTrack:function(a){delete this.tracks[a.name]},play:function(){this.playing||(this.playing=!0,this.beatCount=0,this.playStampStart=(new Date).getTime(),this.playBeat(),this.hook("play"))},pause:function(){this.playing=!1;this.wjs.window.clearTimeout(this.timeout);
this.hook("pause")},stop:function(){this.pause();this.hook("replay")},bmpSet:function(a){this.bpm=a;this.bpmMiliseconds=60/this.bpm*1E3},playBeat:function(){for(var a=0,b,c=Object.keys(this.tracks),d=0;b=this.tracks[c[a++]];)d=this.beatCount%b.beatsLength,0===d?b.looped&&b.replay():0===d%4?this.trackSync(b):this.trackSync(b,0.1);this.beatCount++;this.timeout=this.wjs.window.setTimeout(this.playBeat.bind(this),this.playStampStart+this.beatCount*this.bpmMiliseconds-(new Date).getTime())},hook:function(a){for(var b=
0,c,d=Object.keys(this.tracks);c=this.tracks[d[b++]];)c[a]()}})})(WjsProto);
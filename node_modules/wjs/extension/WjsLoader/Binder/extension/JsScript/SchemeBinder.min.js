// @require JsScript > SchemeWebCom
// @require JsMethod > inheritLinage
// @require JsMethod > arrayDeleteItem
(function(k){k.register("WebComScheme","SchemeBinder",{classExtends:"WebCom",type:"Binder",variables:{listeners:{},statesVars:{},stateConnected:{},stateListener:{},formulaVarListenersCounter:{}},states:{},options:{cssClasses:{define:function(a,b){b=b||[];if(a.loader.classLists[a.typeGlobal])return b.concat(a.loader.classLists[a.typeGlobal])}},cssFadeIn:{define:function(a,b,c){var e=0,d,f=a.loader;d=f.protoName(a.type);var g=f.domStyle[d];if(g)for(;d=f.classLists[a.typeGlobal][e++];)a.cssRulesClassSearch(g.sheet,
d)&&(a.classLoads.typeGlobal=!0);return this.__super("define",[a,b,c])}}},__construct:function(a){var b=this.loader.webCompSchemes[this.protoClassName];if(b.callbacks&&b.callbacks.domListen)for(var c=0,e=Object.keys(b.callbacks.domListen);b=e[c++];)b=this.methodName("callbacks.domListen."+b),this[b]=this[b].bind(this);this.__super("__construct",arguments);this.wjs.inheritLinage(this,"states")},callbackFind:function(a,b){return"function"===typeof a?a:this.method("callbacks."+b+"."+a)},domChildFill:function(a,
b){this.__super("domChildFill",arguments);this.trigger("domChildFill",[a,b])},domChildRemove:function(a){a=this.domChildGet(a);a.parentNode.removeChild(a)},domStyleGet:function(a){return this.wjs.window.getComputedStyle(this.dom,null).getPropertyValue(a)},domRect:function(){return this.dom.getBoundingClientRect()},variableSet:function(a,b){b&&b.formula&&this.formulaListenAll(b,!1);b&&b.formula&&this.formulaListenAll(b);this.__super("variableSet",arguments)},variableGet:function(a){var b=this.__super("variableGet",
arguments);return void 0!==b&&b.formula?this.wjs.formula.result(b,this):b},formulaListenAll:function(a,b){this.objectInspect(a,this.formulaListen.bind(this),b)},formulaListen:function(a,b){if(a&&a.formula){var c=a.formula,e=this.wjs.formula.formulas[c];if(e&&e.eventTrigger&&this.formulaChangeCallback){var d=this.formulaVarListenersCounter;!1===b&&0<d[c]?(d[c]--,0===d[c]&&(this.wjs.window.removeEventListener(e.eventNameUpdate,this.formulaChangeCallback),delete d[c])):(d[c]||this.wjs.window.addEventListener(e.eventNameUpdate,
this.formulaChangeCallback),d[c]=d[c]||0,d[c]++)}}},objectInspect:function(a,b,c,e){e=e||0;if("object"===typeof a){var d=b(a,c,e);if(null!==d)for(var f=Object.keys(a),g=0,h;h=f[g++];)if(!1===this.objectInspect(a[h],b,c,e+1))return;return d}},stateSet:function(a,b,c){var e=this.states[a],d;if(b!==e){this.states.hasOwnProperty(a)||this.error("Trying to set undefined state "+a);d=this.callbackFind(a,"stateSet");this.states[a]=b;this.statesVars[a]=this.statesVars[a]||{};this.wjs.extendObject(this.statesVars[a],
c||{});if(d)this[this.methodName("callbacks.stateSet."+a)](b,c,e);this.trigger("stateSet",[a,b,e])}},stateGet:function(a){return this.states[a]},stateIs:function(a,b){"string"===typeof a&&(a={},a[a]=b);for(var c=0,e,d=Object.keys(a);e=d[c++];)if(this.states[e]!==a[e])return!1;return!0},stateListen:function(a,b,c,e){c=this.callbackFind(c,"stateListen");this.stateListener[a.id]=this.stateListener[a.id]||{};this.stateListener[a.id][b]=c;1===Object.keys(this.stateListener[a.id]).length&&this.listen(a,
"stateSet","stateListen");e&&c.apply(this,[a,b,a.stateGet(b)])},stateForget:function(a,b,c,e){var d=this.stateListener[a.id];c=this.callbackFind(c,"stateListen");e&&this.callbackFind(c,"stateListen").apply(this,[a,b,a.stateGet(b)]);delete d[b];0===Object.keys(d).length&&this.forget(a,"stateSet")},stateConnect:function(a,b,c,e){var d=this.stateConnected;d[a.id]=d[a.id]||{};d[a.id][b]=d[a.id][b]||[];d[a.id][b].push(c);this.stateListen(a,b,this.callbackFind("stateConnect","stateListen"),e)},stateDisconnect:function(a,
b,c,e){var d=this.stateConnected;if(d=d[a.id]?d[a.id][b]:void 0)this.wjs.arrayDeleteItem(d,c),this.stateForget(a,b,this.callbackFind("stateConnect","stateListen"),e)},listen:function(a,b,c){c=this.callbackFind(c,"listen");return!!a.listenerAdd(b,this,c)},forget:function(a,b){return!!a.listenerRemove(b,this)},hasListener:function(a,b){return this.listeners[a]&&this.listeners[a][b.id]},listenerAdd:function(a,b,c){return this.hasListener(a,b)?!1:(this.listeners[a]=this.listeners[a]||{},this.listeners[a][b.id]=
c,!0)},listenerRemove:function(a,b){this.hasListener(a,b)&&(delete this.listeners[a][b.id],0===Object.keys(this.listeners[a]).length&&delete this.listeners[a])},trigger:function(a,b){var c={},e=0,d,f=this.listeners[a]||{},g,h=Object.keys(f);b=b||[];for(b.unshift(this);g=h[e++];)(d=this.wjs.loaders.WebCom.webComList[g])&&(c[d.id]=f[g].apply(d,b));return c},domListen:function(a,b,c){this.domNodeListMap("domListen",arguments)||a.addEventListener(b,"function"===typeof c?c:this[this.methodName("callbacks.domListen."+
c)])},domForget:function(a,b,c){this.domNodeListMap("domForget",arguments)||a.removeEventListener(b,"function"===typeof c?c:this[this.methodName("callbacks.domListen."+c)])},domNodeListMap:function(a,b){var c=this,e;return b[0]instanceof c.wjs.window.NodeList?(e=c.wjs.extendObject([],b),Array.prototype.slice.call(b[0]).map(function(b){e[0]=b;c[a].apply(c,e)},this),!0):!1},callbacks:{listen:{stateListen:function(a,b,c,e){var d=this.stateListener[a.id]?this.stateListener[a.id][b]:void 0;d&&d.apply(this,
[a,b,c,e])}},stateListen:{stateConnect:function(a,b,c){a=this.stateConnected[a.id]?this.stateConnected[a.id][b]:void 0;b=0;var e,d;if(a)for(e=Object.keys(a);d=e[b++];)this.stateSet(a[d],c)}}}})})(WjsProto);
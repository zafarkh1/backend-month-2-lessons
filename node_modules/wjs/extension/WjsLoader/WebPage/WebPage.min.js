// @require JsScript > SchemeWebPage
// @require JsClassStatic > QueueManager
// @require JsMethod > urlQueryParse
// @require JsMethod > extEnable
// @require JsMethod > cssSheetRules
// @require JsMethod > extDisable
// @require JsMethod > wjsRegDiffName
(function(h){h.register("WjsLoader","WebPage",{loaderExtends:"WebCom",protoBaseClass:"WebPage",pageCurrent:null,destroyDelay:5E3,__construct:function(){this.destroyTimeouts={};this.pageRequireStatic=[];this.pageInstances=[];this.pageReadyCallbacks=[];this.pageShowLast=void 0;var a=this.wjs.urlQueryParse();a[this.type]&&(delete a[this.type],this.wjs.urlQueryReplace(a));this.wjs.loaders.WebCom.__construct.call(this);this.queueName=this.type+"PageLoads";this.wjs.window.addEventListener("popstate",this.onPopState.bind(this))},
onPopState:function(a){var d=this.wjs.urlQueryParse();a.state.type===this.type&&a.state.name?this.pageHide(a.state.name):d[this.type]&&this.pageHide(d[this.type])},link:function(a){a!==this.pageShowLast&&(this.pageShowLast=a,this.pageShow(a))},enable:function(a,d,b){b&&b.options.webPagePreload||this.instance(a,d)},pageChange:function(a){this.pageCurrent[a]&&this.pageHide(this.pageCurrent[a])},pageShow:function(a,d){var b=this,c=b.wjs,e=b.type;c.queueAdd(b.queueName,function(){if(b.pageCurrent)b.pageCurrent.name!==
a&&b.pageHide(a,d),c.queueNext(b.queueName);else if(b.destroyTimeoutClear(a),c.get(e,a))if(c.extRequire[e]&&c.extRequire[e][a]&&c.extRequire[e][a].CssLink){for(var g=0,f,l=function(){for(g=0;f=c.extRequire[e][a].CssLink[g++];){var k=c.get("CssLink",f),h=c.cssSheetRules(k.sheet);k.sheet&&h?(c.extEnable(e,a),d&&d(),c.queueNext(b.queueName)):c.window.setTimeout(l,100)}};f=c.extRequire[e][a].CssLink[g++];)c.loaders.CssLink.enable(f,c.get("CssLink",f));c.window.setTimeout(l,100)}else c.extEnable(e,a),
c.queueNext(b.queueName);else c.use(e,a,function(){b.pageShowLast=void 0;b.pageShow(a,d);c.queueNext(b.queueName)})})},pageHide:function(a,d){var b=this;b.wjs.queueAdd(b.queueName,function(){var c=b.pageCurrent,e=!a,g=!c,f=function(){e&&g&&(c&&(b.wjs.extDisable(c.loader.type,c.type),c.loader.destroyTimeout(c.type)),b.pageHideStarted=!1,a?b.pageShow(a,d):d&&d(),b.wjs.queueNext(b.queueName))};a&&(b.destroyTimeoutClear(a),b.wjs.use(b.type,a,{webPagePreload:!0,complete:function(){e=!0;f()}}));c&&b.pageCurrent.exit(function(){g=
!0;f()});a||c||f()})},pageReady:function(a){this.pageReadyCallbacks.push(a)},destroyTimeout:function(a){var d=this;d.destroyTimeouts[a]=d.wjs.window.setTimeout(function(){delete d.destroyTimeouts[a];if(d.pageCurrent){var b=d.wjs.wjsRegDiffName(d.type,a,d.type,d.pageCurrent.type);Object.keys(b).length?(b[d.type]=b[d.type]||[],b[d.type].push(a)):d.wjs.destroy(d.type,a)}},d.destroyDelay)},destroyTimeoutClear:function(a){this.destroyTimeouts[a]&&this.wjs.window.clearTimeout(this.destroyTimeouts[a])}})})(WjsProto);